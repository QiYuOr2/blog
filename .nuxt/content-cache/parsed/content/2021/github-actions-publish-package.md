{"parsed":{"_path":"/2021/github-actions-publish-package","_dir":"2021","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"使用Github Actions自动化发布npm包的探索","description":"最近编写了一个封装了前端存储 API 的工具库symstorage，准备将它发布在 npm 上方便以后使用，不过如果每次都手动从本地打包发布的话就会非常麻烦，因此这次尝试一下自动化发布。","excerpt":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最近编写了一个封装了前端存储 API 的工具库"},{"type":"element","tag":"a","props":{"href":"https://www.npmjs.com/package/symstorage","rel":["nofollow"]},"children":[{"type":"text","value":"symstorage"}]},{"type":"text","value":"，准备将它发布在 npm 上方便以后使用，不过如果每次都手动从本地打包发布的话就会非常麻烦，因此这次尝试一下自动化发布。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"查看了许多相关文章后，我决定使用 Github Actions 配合 semantic-release 进行自动化发布。\n有关"},{"type":"element","tag":"a","props":{"href":"https://semantic-release.gitbook.io/semantic-release/","rel":["nofollow"]},"children":[{"type":"text","value":"semantic-release"}]},{"type":"text","value":"的详细介绍可以阅读官方文档，这里只做一些概述性的总结。"}]},{"type":"element","tag":"h2","props":{"id":"semantic-release"},"children":[{"type":"text","value":"semantic-release"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"semantic-release 的大致工作流程如下："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"提交到特定的分支触发 release 流程"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"验证 commit 信息，生成 release note，打 git tag"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"其他后续流程，如生成 CHANGELOG.md，npm publish 等等（通过插件完成）"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"它会根据规范化的 commit 信息进行发布并生成发布信息，默认规则："}]},{"type":"element","tag":"code","props":{"code":"# 修复bug，更新小版本1.0.x\nfix: <message>\n\n# 添加新功能，更新次版本号1.x.0\nfeat: <message>\n\n# 如果feat中包含BREAKING CHANGE则会更新主版本x.0.0\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# 修复bug，更新小版本1.0.x\nfix: <message>\n\n# 添加新功能，更新次版本号1.x.0\nfeat: <message>\n\n# 如果feat中包含BREAKING CHANGE则会更新主版本x.0.0\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"当然也可以通过插件配置自定义规则"}]},{"type":"element","tag":"h2","props":{"id":"配置自动化发布"},"children":[{"type":"text","value":"配置自动化发布"}]},{"type":"element","tag":"h3","props":{"id":"配置-github-actions"},"children":[{"type":"text","value":"配置 Github Actions"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"往期 Github Actions 相关文章："},{"type":"element","tag":"a","props":{"href":"https://qiyuor2.github.io/categories/%E5%B7%A5%E5%85%B7/useactionstopages/","rel":["nofollow"]},"children":[{"type":"text","value":"使用 Github Actions 将 Vue 项目部署到 Github Pages"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"根目录下创建"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":".github/workflows/release.yml"}]},{"type":"text","value":"，并填入如下内容："}]},{"type":"element","tag":"code","props":{"code":"name: Release\non:\n  push:\n    branches:\n      - main\njobs:\n  release:\n    name: Release\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v2\n        with:\n          fetch-depth: 0\n      - name: Setup Node.js\n        uses: actions/setup-node@v1\n        with:\n          node-version: 12\n      - name: Install dependencies\n        run: npm ci\n      - name: Release\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\n        run: npx semantic-release\n","language":"yml"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"name: Release\non:\n  push:\n    branches:\n      - main\njobs:\n  release:\n    name: Release\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v2\n        with:\n          fetch-depth: 0\n      - name: Setup Node.js\n        uses: actions/setup-node@v1\n        with:\n          node-version: 12\n      - name: Install dependencies\n        run: npm ci\n      - name: Release\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\n        run: npx semantic-release\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"官方参考文档："},{"type":"element","tag":"a","props":{"href":"https://github.com/semantic-release/semantic-release/blob/master/docs/recipes/github-actions.md","rel":["nofollow"]},"children":[{"type":"text","value":"Using semantic-release with GitHub Actions"}]}]},{"type":"element","tag":"h3","props":{"id":"配置-semantic-release"},"children":[{"type":"text","value":"配置 semantic-release"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先需要安装 semantic-release："}]},{"type":"element","tag":"code","props":{"code":"npm i -D semantic-release @semantic-release/changelog @semantic-release/git\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"npm i -D semantic-release @semantic-release/changelog @semantic-release/git\n"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"@semantic-release/changelog"}]},{"type":"text","value":" 用来生成 CHANGELOG.md 日志文件"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"@semantic-release/git"}]},{"type":"text","value":" 用来自动修改 package.json 版本号，并提交到 Github 上"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后在根目录下创建"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":".releaserc"}]},{"type":"text","value":"，并填入如下内容："}]},{"type":"element","tag":"code","props":{"code":"{\n  \"branches\": \"main\",\n  \"plugins\": [\n    \"@semantic-release/commit-analyzer\",\n    \"@semantic-release/release-notes-generator\",\n    \"@semantic-release/changelog\",\n    \"@semantic-release/npm\",\n    [\n      \"@semantic-release/git\",\n      {\n        \"assets\": [\"package.json\", \"CHANGELOG.md\"],\n        \"message\": \"chore(release): ${nextRelease.version} [skip ci]\\n\\n${nextRelease.notes}\"\n      }\n    ],\n    \"@semantic-release/github\"\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"branches\": \"main\",\n  \"plugins\": [\n    \"@semantic-release/commit-analyzer\",\n    \"@semantic-release/release-notes-generator\",\n    \"@semantic-release/changelog\",\n    \"@semantic-release/npm\",\n    [\n      \"@semantic-release/git\",\n      {\n        \"assets\": [\"package.json\", \"CHANGELOG.md\"],\n        \"message\": \"chore(release): ${nextRelease.version} [skip ci]\\n\\n${nextRelease.notes}\"\n      }\n    ],\n    \"@semantic-release/github\"\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"配置中有一些我们没有手动安装的包已经在安装 semantic-release 时自动安装了"}]},{"type":"element","tag":"h3","props":{"id":"授权"},"children":[{"type":"text","value":"授权"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 npm 官网登陆后，点击头像，选择 Access Tokens，点击 Generate New Token 按钮，之后选择类型为 Publish 生成"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"npm授权","src":"https://gcore.jsdelivr.net/gh/qiyuor2/blog-image/img/npmaccesstoken.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然后到仓库的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Settings/Secret"}]},{"type":"text","value":"下，点击"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"New repository secret"}]},{"type":"text","value":"将刚才保存的密钥保存，并命名为"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"NPM_TOKEN"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果这里命名不为 NPM_TOKEN，上面的 release.yml 中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"${{ secrets.NPM_TOKEN }}"}]},{"type":"text","value":"也需要修改。GITHUB_TOKEN 会自动生成，不需要手动配置"}]}]},{"type":"element","tag":"h2","props":{"id":"执行"},"children":[{"type":"text","value":"执行"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"配置完成后就可以尝试提交发布了"}]},{"type":"element","tag":"code","props":{"code":"git add .\ngit commit -m 'feat: semantic-release' # 注意feat:后需要一个空格\ngit push\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"git add .\ngit commit -m 'feat: semantic-release' # 注意feat:后需要一个空格\ngit push\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"参考文章"},"children":[{"type":"text","value":"参考文章"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://blog.dteam.top/posts/2020-05/semantic-release.html","rel":["nofollow"]},"children":[{"type":"text","value":"团队敏捷实践 —— 使用 semantic-release 自动管理发布版本"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://meixg.cn/2021/01/20/semantic-release-guide/","rel":["nofollow"]},"children":[{"type":"text","value":"Github 自动发版机器人 semantic-release 配置教程"}]}]}]}]},"date":"2021/05/28 16:31:54","tags":["Github Actions","CI"],"category":"工具","summary":"最近编写了一个封装了前端存储 API 的工具库，准备将它发布在 npm 上方便以后使用，不过如果每次都手动从本地打包发布的话就会非常麻烦，因此这次尝试一下自动化发布。","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最近编写了一个封装了前端存储 API 的工具库"},{"type":"element","tag":"a","props":{"href":"https://www.npmjs.com/package/symstorage","rel":["nofollow"]},"children":[{"type":"text","value":"symstorage"}]},{"type":"text","value":"，准备将它发布在 npm 上方便以后使用，不过如果每次都手动从本地打包发布的话就会非常麻烦，因此这次尝试一下自动化发布。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"查看了许多相关文章后，我决定使用 Github Actions 配合 semantic-release 进行自动化发布。\n有关"},{"type":"element","tag":"a","props":{"href":"https://semantic-release.gitbook.io/semantic-release/","rel":["nofollow"]},"children":[{"type":"text","value":"semantic-release"}]},{"type":"text","value":"的详细介绍可以阅读官方文档，这里只做一些概述性的总结。"}]},{"type":"element","tag":"h2","props":{"id":"semantic-release"},"children":[{"type":"text","value":"semantic-release"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"semantic-release 的大致工作流程如下："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"提交到特定的分支触发 release 流程"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"验证 commit 信息，生成 release note，打 git tag"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"其他后续流程，如生成 CHANGELOG.md，npm publish 等等（通过插件完成）"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"它会根据规范化的 commit 信息进行发布并生成发布信息，默认规则："}]},{"type":"element","tag":"code","props":{"code":"# 修复bug，更新小版本1.0.x\nfix: <message>\n\n# 添加新功能，更新次版本号1.x.0\nfeat: <message>\n\n# 如果feat中包含BREAKING CHANGE则会更新主版本x.0.0\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# 修复bug，更新小版本1.0.x\nfix: <message>\n\n# 添加新功能，更新次版本号1.x.0\nfeat: <message>\n\n# 如果feat中包含BREAKING CHANGE则会更新主版本x.0.0\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"当然也可以通过插件配置自定义规则"}]},{"type":"element","tag":"h2","props":{"id":"配置自动化发布"},"children":[{"type":"text","value":"配置自动化发布"}]},{"type":"element","tag":"h3","props":{"id":"配置-github-actions"},"children":[{"type":"text","value":"配置 Github Actions"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"往期 Github Actions 相关文章："},{"type":"element","tag":"a","props":{"href":"https://qiyuor2.github.io/categories/%E5%B7%A5%E5%85%B7/useactionstopages/","rel":["nofollow"]},"children":[{"type":"text","value":"使用 Github Actions 将 Vue 项目部署到 Github Pages"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"根目录下创建"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":".github/workflows/release.yml"}]},{"type":"text","value":"，并填入如下内容："}]},{"type":"element","tag":"code","props":{"code":"name: Release\non:\n  push:\n    branches:\n      - main\njobs:\n  release:\n    name: Release\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v2\n        with:\n          fetch-depth: 0\n      - name: Setup Node.js\n        uses: actions/setup-node@v1\n        with:\n          node-version: 12\n      - name: Install dependencies\n        run: npm ci\n      - name: Release\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\n        run: npx semantic-release\n","language":"yml"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"name: Release\non:\n  push:\n    branches:\n      - main\njobs:\n  release:\n    name: Release\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v2\n        with:\n          fetch-depth: 0\n      - name: Setup Node.js\n        uses: actions/setup-node@v1\n        with:\n          node-version: 12\n      - name: Install dependencies\n        run: npm ci\n      - name: Release\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\n        run: npx semantic-release\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"官方参考文档："},{"type":"element","tag":"a","props":{"href":"https://github.com/semantic-release/semantic-release/blob/master/docs/recipes/github-actions.md","rel":["nofollow"]},"children":[{"type":"text","value":"Using semantic-release with GitHub Actions"}]}]},{"type":"element","tag":"h3","props":{"id":"配置-semantic-release"},"children":[{"type":"text","value":"配置 semantic-release"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先需要安装 semantic-release："}]},{"type":"element","tag":"code","props":{"code":"npm i -D semantic-release @semantic-release/changelog @semantic-release/git\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"npm i -D semantic-release @semantic-release/changelog @semantic-release/git\n"}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"@semantic-release/changelog"}]},{"type":"text","value":" 用来生成 CHANGELOG.md 日志文件"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"@semantic-release/git"}]},{"type":"text","value":" 用来自动修改 package.json 版本号，并提交到 Github 上"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后在根目录下创建"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":".releaserc"}]},{"type":"text","value":"，并填入如下内容："}]},{"type":"element","tag":"code","props":{"code":"{\n  \"branches\": \"main\",\n  \"plugins\": [\n    \"@semantic-release/commit-analyzer\",\n    \"@semantic-release/release-notes-generator\",\n    \"@semantic-release/changelog\",\n    \"@semantic-release/npm\",\n    [\n      \"@semantic-release/git\",\n      {\n        \"assets\": [\"package.json\", \"CHANGELOG.md\"],\n        \"message\": \"chore(release): ${nextRelease.version} [skip ci]\\n\\n${nextRelease.notes}\"\n      }\n    ],\n    \"@semantic-release/github\"\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"branches\": \"main\",\n  \"plugins\": [\n    \"@semantic-release/commit-analyzer\",\n    \"@semantic-release/release-notes-generator\",\n    \"@semantic-release/changelog\",\n    \"@semantic-release/npm\",\n    [\n      \"@semantic-release/git\",\n      {\n        \"assets\": [\"package.json\", \"CHANGELOG.md\"],\n        \"message\": \"chore(release): ${nextRelease.version} [skip ci]\\n\\n${nextRelease.notes}\"\n      }\n    ],\n    \"@semantic-release/github\"\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"配置中有一些我们没有手动安装的包已经在安装 semantic-release 时自动安装了"}]},{"type":"element","tag":"h3","props":{"id":"授权"},"children":[{"type":"text","value":"授权"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 npm 官网登陆后，点击头像，选择 Access Tokens，点击 Generate New Token 按钮，之后选择类型为 Publish 生成"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"npm授权","src":"https://gcore.jsdelivr.net/gh/qiyuor2/blog-image/img/npmaccesstoken.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然后到仓库的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Settings/Secret"}]},{"type":"text","value":"下，点击"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"New repository secret"}]},{"type":"text","value":"将刚才保存的密钥保存，并命名为"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"NPM_TOKEN"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果这里命名不为 NPM_TOKEN，上面的 release.yml 中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"${{ secrets.NPM_TOKEN }}"}]},{"type":"text","value":"也需要修改。GITHUB_TOKEN 会自动生成，不需要手动配置"}]}]},{"type":"element","tag":"h2","props":{"id":"执行"},"children":[{"type":"text","value":"执行"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"配置完成后就可以尝试提交发布了"}]},{"type":"element","tag":"code","props":{"code":"git add .\ngit commit -m 'feat: semantic-release' # 注意feat:后需要一个空格\ngit push\n","language":"bash"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"git add .\ngit commit -m 'feat: semantic-release' # 注意feat:后需要一个空格\ngit push\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"参考文章"},"children":[{"type":"text","value":"参考文章"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://blog.dteam.top/posts/2020-05/semantic-release.html","rel":["nofollow"]},"children":[{"type":"text","value":"团队敏捷实践 —— 使用 semantic-release 自动管理发布版本"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://meixg.cn/2021/01/20/semantic-release-guide/","rel":["nofollow"]},"children":[{"type":"text","value":"Github 自动发版机器人 semantic-release 配置教程"}]}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"semantic-release","depth":2,"text":"semantic-release"},{"id":"配置自动化发布","depth":2,"text":"配置自动化发布","children":[{"id":"配置-github-actions","depth":3,"text":"配置 Github Actions"},{"id":"配置-semantic-release","depth":3,"text":"配置 semantic-release"},{"id":"授权","depth":3,"text":"授权"}]},{"id":"执行","depth":2,"text":"执行"},{"id":"参考文章","depth":2,"text":"参考文章"}]}},"_type":"markdown","_id":"content:2021:github-actions-publish-package.md","_source":"content","_file":"2021/github-actions-publish-package.md","_extension":"md"},"hash":"aHeNCxAhjz"}