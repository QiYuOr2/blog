{"parsed":{"_path":"/2021/chrome-ext-get-image","_dir":"2021","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Chrome插件开发入门","description":"最近学习了 Chrome 插件的开发，总体来说上手还是很容易的，因为浏览器插件本质上依旧是网页，写几个 demo 基本就了解了他的开发过程。","excerpt":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最近学习了 Chrome 插件的开发，总体来说上手还是很容易的，因为浏览器插件本质上依旧是网页，写几个 demo 基本就了解了他的开发过程。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"完整项目："},{"type":"element","tag":"a","props":{"href":"https://github.com/qiyuor2/chrome-extension-getimage","rel":["nofollow"]},"children":[{"type":"text","value":"qiyuor2/chrome-extension-getimage"}]}]}]},{"type":"element","tag":"h2","props":{"id":"什么是-chrome-插件"},"children":[{"type":"text","value":"什么是 Chrome 插件"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"正如开头所说的，Chrome 插件实际上就是一个网页，由 HTML、CSS、JS、图片等资源组成，与网页不同的是，Chrome 插件是用来增强浏览器功能的，同时它还有一套属于自己的开发规则和 API。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"每个插件都由不同的组件构成，这些组件大都包括 background scripts，content scripts，options page，UI 以及各种逻辑文件，当然，这些文件是否需要是根据插件的功能所决定的。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"接下来我将通过开发一个获取页面图片并保存的插件来介绍如何开发一个 Chrome 插件。"}]},{"type":"element","tag":"h2","props":{"id":"获取页面上的图片"},"children":[{"type":"text","value":"获取页面上的图片"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先，我们需要一个目录来存放这个插件的各个文件。"}]},{"type":"element","tag":"h3","props":{"id":"创建-manifest"},"children":[{"type":"text","value":"创建 manifest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"是一个 Chrome 插件必不可少的文件，它包含了你插件的所有信息。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"只要在目录中包含"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"，这个目录就可以被作为一个 Chrome 插件添加到 Chrome 当中。"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在浏览器地址栏中输入"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"chrome://extensions"}]},{"type":"text","value":"，回车以打开浏览器的扩展程序界面"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"打开开发人员模式"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"点击"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"加载已解压的扩展程序"}]},{"type":"text","value":"，选择 manifest 文件所在的目录"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这样我们就成功安装了一个扩展，接下来我们要在此基础上完善它。"}]},{"type":"element","tag":"h4","props":{"id":"用户界面"},"children":[{"type":"text","value":"用户界面"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"一个插件可以有多种形式的用户界面，这里我们选择弹出层作为用户界面，在插件根目录下创建一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"，这个页面需要包含两个按钮分别用来触发获取图片和保存图片的事件，以及一个用来展示图片的盒子。"}]},{"type":"element","tag":"code","props":{"code":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n  </body>\n</html>\n","language":"html"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n  </body>\n</html>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"注意，如果在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"中有中文出现，一定要在 head 标签中添加"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<meta charset=\"UTF-8\" />"}]},{"type":"text","value":"，以防止出现乱码。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"创建完成后，我们需要在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中声明该页面，以保证浏览器能够正确的读取到它。添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"action"}]},{"type":"text","value":"对象，同时将"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"设置为该对象的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"default_popup"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\"\n  }\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\"\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"为了让我们的插件像个正经的插件，给他添加上图标。我们需要准备 16x16、32x32、48x48 以及 128x128 四种大小的图标图片，将它们放到目录中，之后将它们的路径写入"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  }\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"为了让图标能够在扩展程序管理页面显示，我们还需要添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"icons"}]},{"type":"text","value":"对象。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  },\n  \"icons\": {\n    \"16\": \"/images/logo16.png\",\n    \"32\": \"/images/logo32.png\",\n    \"48\": \"/images/logo48.png\",\n    \"128\": \"/images/logo128.png\"\n  }\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  },\n  \"icons\": {\n    \"16\": \"/images/logo16.png\",\n    \"32\": \"/images/logo32.png\",\n    \"48\": \"/images/logo48.png\",\n    \"128\": \"/images/logo128.png\"\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"点击扩展程序管理页面中的更新按钮，即可看到添加完用户界面的插件信息了。"}]},{"type":"element","tag":"h4","props":{"id":"功能逻辑"},"children":[{"type":"text","value":"功能逻辑"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后我们要为插件添加它应有的功能——获取页面图片。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先我们先简单梳理一下需求："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"点击 popup.html 中的获取按钮，拿到当前页面的图片"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"点击 popup.html 中的保存按钮，将拿到的图片保存下来"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"实际上我们的插件与当前正在活动的页面并不是同一个页面，因此我们需要通过某种方式来将获取图片的 js 代码发送到当前活动页上，并且还需要这段 js 代码能够在获取到图片之后将图片发送到"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"中。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这里我们就需要用到一开始提到的 content scripts 组件以及 content script 与 popup 之间通信的 API。content scripts 简单来说就是插入页面的脚本，虽说是插入页面的脚本，实际上它与页面原本的 js 是分割开的，双方不能获取到对方的变量、函数等内容。不过 content scripts 还是可以获取到 dom 的。"}]},{"type":"element","tag":"h5","props":{"id":"获取图片"},"children":[{"type":"text","value":"获取图片"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"content-script.js"}]},{"type":"text","value":"，这个脚本主要有两个功能，一是获取图片，二是监听 popup 传来的消息，然后将获取到的图片作为回信传回去。"}]},{"type":"element","tag":"code","props":{"code":"chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  // message的数据格式取决于发送时的数据\n  const { start } = message;\n\n  if (start) {\n    const images = document.getElementsByTagName('img');\n    const imgSrcList = Array.from(images).map((img) => img.src);\n    sendResponse(imgSrcList);\n  }\n});\n","language":"javascript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  // message的数据格式取决于发送时的数据\n  const { start } = message;\n\n  if (start) {\n    const images = document.getElementsByTagName('img');\n    const imgSrcList = Array.from(images).map((img) => img.src);\n    sendResponse(imgSrcList);\n  }\n});\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后我们要在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中声明配置它"}]},{"type":"element","tag":"code","props":{"code":"{\n  ...\n  \"content_scripts\": [\n    {\n      \"matches\": [\n        \"<all_urls>\"\n      ],\n      \"js\": [\n        \"js/content-script.js\"\n      ]\n    }\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  ...\n  \"content_scripts\": [\n    {\n      \"matches\": [\n        \"<all_urls>\"\n      ],\n      \"js\": [\n        \"js/content-script.js\"\n      ]\n    }\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"matches"}]},{"type":"text","value":"声明了 content scripts 要注入的页面，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<all_urls>"}]},{"type":"text","value":"表示所有页面，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"js"}]},{"type":"text","value":"属性声明了要注入的 js 脚本，除此之外还有"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"css"}]},{"type":"text","value":"属性声明要注入的 css 代码、"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"run_at"}]},{"type":"text","value":"属性声明注入时机等都可以在官方文档中找到。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.js"}]},{"type":"text","value":"为界面上的按钮注册点击事件，并在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"中引入它"}]},{"type":"element","tag":"code","props":{"code":"let srcList;\nconst getImageBtn = document.getElementById('get');\n\ngetImageBtn.addEventListener('click', async () => {\n  // 获取当前活动页\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    let message = { start: true };\n    // 向content scripts发送消息\n    chrome.tabs.sendMessage(tab.id, message, (res) => {\n      srcList = Array.from(new Set(res));\n      // popup中展示图片\n      const imgList = srcList.map((src) => `<img src=\"${src}\" />`).join('');\n\n      document.getElementById('app').innerHTML = imgList;\n    });\n  });\n});\n\nconst saveImageBtn = document.getElementById('save');\n\nsaveImageBtn.addEventListener('click', () => {\n  // 保存图片\n});\n","language":"javascript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"let srcList;\nconst getImageBtn = document.getElementById('get');\n\ngetImageBtn.addEventListener('click', async () => {\n  // 获取当前活动页\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    let message = { start: true };\n    // 向content scripts发送消息\n    chrome.tabs.sendMessage(tab.id, message, (res) => {\n      srcList = Array.from(new Set(res));\n      // popup中展示图片\n      const imgList = srcList.map((src) => `<img src=\"${src}\" />`).join('');\n\n      document.getElementById('app').innerHTML = imgList;\n    });\n  });\n});\n\nconst saveImageBtn = document.getElementById('save');\n\nsaveImageBtn.addEventListener('click', () => {\n  // 保存图片\n});\n"}]}]}]},{"type":"element","tag":"code","props":{"code":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n    <script src=\"./js/popup.js\"></script>\n  </body>\n</html>\n","language":"html"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n    <script src=\"./js/popup.js\"></script>\n  </body>\n</html>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这里我们需要注意，插件要想和当前活动页面通信就需要首先获取它的 tabId，而要获取当前活动页面的 tabId 则需要给予插件对应的权限，因此我们需要在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中声明所需要的权限。"}]},{"type":"element","tag":"code","props":{"code":"{\n  ...\n  \"permissions\": [\n    \"activeTab\"\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  ...\n  \"permissions\": [\n    \"activeTab\"\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"完成后更新一下插件，然后打开想要获取图片的页面点击获取按钮即可（如果页面已经提前打开请刷新一下）"}]},{"type":"element","tag":"h5","props":{"id":"保存图片"},"children":[{"type":"text","value":"保存图片"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"js 可以通过 a 标签设置 href 和 download 属性来实现批量保存图片，但是这里我们要通过调用 chrome 的 download API 来实现。"}]},{"type":"element","tag":"code","props":{"code":"...\n\nsaveImageBtn.addEventListener('click', () => {\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    if (!srcList) {\n      document.getElementById('app').innerHTML = '未获取图片';\n      return;\n    }\n\n    srcList.forEach((src) => {\n      chrome.downloads.download({\n        url: src,\n      });\n    });\n  });\n});\n","language":"javascript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"...\n\nsaveImageBtn.addEventListener('click', () => {\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    if (!srcList) {\n      document.getElementById('app').innerHTML = '未获取图片';\n      return;\n    }\n\n    srcList.forEach((src) => {\n      chrome.downloads.download({\n        url: src,\n      });\n    });\n  });\n});\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"与获取活动页面相同，download API 同样也需要获取权限"}]},{"type":"element","tag":"code","props":{"code":"{\n  ...\n  \"permissions\": [\n    \"activeTab\",\n    \"downloads\"\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  ...\n  \"permissions\": [\n    \"activeTab\",\n    \"downloads\"\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这样一个获取当前页面图片的插件就完成了。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"完整项目："},{"type":"element","tag":"a","props":{"href":"https://github.com/qiyuor2/chrome-extension-getimage","rel":["nofollow"]},"children":[{"type":"text","value":"qiyuor2/chrome-extension-getimage"}]}]}]},{"type":"element","tag":"h2","props":{"id":"参考文章"},"children":[{"type":"text","value":"参考文章"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://developer.chrome.com/docs/extensions/mv3/getstarted/","rel":["nofollow"]},"children":[{"type":"text","value":"谷歌官方文档"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://juejin.cn/post/6844903740646899720","rel":["nofollow"]},"children":[{"type":"text","value":"一篇文章教你顺利入门和开发 chrome 扩展程序（插件）"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://juejin.cn/post/6844903985711677453","rel":["nofollow"]},"children":[{"type":"text","value":"入门系列 3 - background、content、popup 的通信"}]}]}]}]},"date":"2021/04/18 17:22:37","tags":["chrome","JavaScript","extension"],"category":"技术","summary":"最近学习了Chrome插件的开发，总体来说上手还是很容易的，因为浏览器插件本质上依旧是网页，写几个demo基本就了解了他的开发过程。","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最近学习了 Chrome 插件的开发，总体来说上手还是很容易的，因为浏览器插件本质上依旧是网页，写几个 demo 基本就了解了他的开发过程。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"完整项目："},{"type":"element","tag":"a","props":{"href":"https://github.com/qiyuor2/chrome-extension-getimage","rel":["nofollow"]},"children":[{"type":"text","value":"qiyuor2/chrome-extension-getimage"}]}]}]},{"type":"element","tag":"h2","props":{"id":"什么是-chrome-插件"},"children":[{"type":"text","value":"什么是 Chrome 插件"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"正如开头所说的，Chrome 插件实际上就是一个网页，由 HTML、CSS、JS、图片等资源组成，与网页不同的是，Chrome 插件是用来增强浏览器功能的，同时它还有一套属于自己的开发规则和 API。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"每个插件都由不同的组件构成，这些组件大都包括 background scripts，content scripts，options page，UI 以及各种逻辑文件，当然，这些文件是否需要是根据插件的功能所决定的。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"接下来我将通过开发一个获取页面图片并保存的插件来介绍如何开发一个 Chrome 插件。"}]},{"type":"element","tag":"h2","props":{"id":"获取页面上的图片"},"children":[{"type":"text","value":"获取页面上的图片"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先，我们需要一个目录来存放这个插件的各个文件。"}]},{"type":"element","tag":"h3","props":{"id":"创建-manifest"},"children":[{"type":"text","value":"创建 manifest"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"是一个 Chrome 插件必不可少的文件，它包含了你插件的所有信息。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"只要在目录中包含"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"，这个目录就可以被作为一个 Chrome 插件添加到 Chrome 当中。"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在浏览器地址栏中输入"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"chrome://extensions"}]},{"type":"text","value":"，回车以打开浏览器的扩展程序界面"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"打开开发人员模式"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"点击"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"加载已解压的扩展程序"}]},{"type":"text","value":"，选择 manifest 文件所在的目录"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这样我们就成功安装了一个扩展，接下来我们要在此基础上完善它。"}]},{"type":"element","tag":"h4","props":{"id":"用户界面"},"children":[{"type":"text","value":"用户界面"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"一个插件可以有多种形式的用户界面，这里我们选择弹出层作为用户界面，在插件根目录下创建一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"，这个页面需要包含两个按钮分别用来触发获取图片和保存图片的事件，以及一个用来展示图片的盒子。"}]},{"type":"element","tag":"code","props":{"code":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n  </body>\n</html>\n","language":"html"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n  </body>\n</html>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"注意，如果在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"中有中文出现，一定要在 head 标签中添加"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<meta charset=\"UTF-8\" />"}]},{"type":"text","value":"，以防止出现乱码。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"创建完成后，我们需要在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中声明该页面，以保证浏览器能够正确的读取到它。添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"action"}]},{"type":"text","value":"对象，同时将"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"设置为该对象的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"default_popup"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\"\n  }\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\"\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"为了让我们的插件像个正经的插件，给他添加上图标。我们需要准备 16x16、32x32、48x48 以及 128x128 四种大小的图标图片，将它们放到目录中，之后将它们的路径写入"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  }\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"为了让图标能够在扩展程序管理页面显示，我们还需要添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"icons"}]},{"type":"text","value":"对象。"}]},{"type":"element","tag":"code","props":{"code":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  },\n  \"icons\": {\n    \"16\": \"/images/logo16.png\",\n    \"32\": \"/images/logo32.png\",\n    \"48\": \"/images/logo48.png\",\n    \"128\": \"/images/logo128.png\"\n  }\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  \"name\": \"获取图片\",\n  \"description\": \"获取页面上的所有图片\",\n  \"version\": \"1.0\",\n  \"manifest_version\": 3,\n  \"action\": {\n    \"default_popup\": \"popup.html\",\n    \"default_icon\": {\n      \"16\": \"/images/logo16.png\",\n      \"32\": \"/images/logo32.png\",\n      \"48\": \"/images/logo48.png\",\n      \"128\": \"/images/logo128.png\"\n    }\n  },\n  \"icons\": {\n    \"16\": \"/images/logo16.png\",\n    \"32\": \"/images/logo32.png\",\n    \"48\": \"/images/logo48.png\",\n    \"128\": \"/images/logo128.png\"\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"点击扩展程序管理页面中的更新按钮，即可看到添加完用户界面的插件信息了。"}]},{"type":"element","tag":"h4","props":{"id":"功能逻辑"},"children":[{"type":"text","value":"功能逻辑"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后我们要为插件添加它应有的功能——获取页面图片。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先我们先简单梳理一下需求："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"点击 popup.html 中的获取按钮，拿到当前页面的图片"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"点击 popup.html 中的保存按钮，将拿到的图片保存下来"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"实际上我们的插件与当前正在活动的页面并不是同一个页面，因此我们需要通过某种方式来将获取图片的 js 代码发送到当前活动页上，并且还需要这段 js 代码能够在获取到图片之后将图片发送到"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"中。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这里我们就需要用到一开始提到的 content scripts 组件以及 content script 与 popup 之间通信的 API。content scripts 简单来说就是插入页面的脚本，虽说是插入页面的脚本，实际上它与页面原本的 js 是分割开的，双方不能获取到对方的变量、函数等内容。不过 content scripts 还是可以获取到 dom 的。"}]},{"type":"element","tag":"h5","props":{"id":"获取图片"},"children":[{"type":"text","value":"获取图片"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"content-script.js"}]},{"type":"text","value":"，这个脚本主要有两个功能，一是获取图片，二是监听 popup 传来的消息，然后将获取到的图片作为回信传回去。"}]},{"type":"element","tag":"code","props":{"code":"chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  // message的数据格式取决于发送时的数据\n  const { start } = message;\n\n  if (start) {\n    const images = document.getElementsByTagName('img');\n    const imgSrcList = Array.from(images).map((img) => img.src);\n    sendResponse(imgSrcList);\n  }\n});\n","language":"javascript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  // message的数据格式取决于发送时的数据\n  const { start } = message;\n\n  if (start) {\n    const images = document.getElementsByTagName('img');\n    const imgSrcList = Array.from(images).map((img) => img.src);\n    sendResponse(imgSrcList);\n  }\n});\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后我们要在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中声明配置它"}]},{"type":"element","tag":"code","props":{"code":"{\n  ...\n  \"content_scripts\": [\n    {\n      \"matches\": [\n        \"<all_urls>\"\n      ],\n      \"js\": [\n        \"js/content-script.js\"\n      ]\n    }\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  ...\n  \"content_scripts\": [\n    {\n      \"matches\": [\n        \"<all_urls>\"\n      ],\n      \"js\": [\n        \"js/content-script.js\"\n      ]\n    }\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"matches"}]},{"type":"text","value":"声明了 content scripts 要注入的页面，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<all_urls>"}]},{"type":"text","value":"表示所有页面，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"js"}]},{"type":"text","value":"属性声明了要注入的 js 脚本，除此之外还有"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"css"}]},{"type":"text","value":"属性声明要注入的 css 代码、"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"run_at"}]},{"type":"text","value":"属性声明注入时机等都可以在官方文档中找到。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之后添加一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.js"}]},{"type":"text","value":"为界面上的按钮注册点击事件，并在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"popup.html"}]},{"type":"text","value":"中引入它"}]},{"type":"element","tag":"code","props":{"code":"let srcList;\nconst getImageBtn = document.getElementById('get');\n\ngetImageBtn.addEventListener('click', async () => {\n  // 获取当前活动页\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    let message = { start: true };\n    // 向content scripts发送消息\n    chrome.tabs.sendMessage(tab.id, message, (res) => {\n      srcList = Array.from(new Set(res));\n      // popup中展示图片\n      const imgList = srcList.map((src) => `<img src=\"${src}\" />`).join('');\n\n      document.getElementById('app').innerHTML = imgList;\n    });\n  });\n});\n\nconst saveImageBtn = document.getElementById('save');\n\nsaveImageBtn.addEventListener('click', () => {\n  // 保存图片\n});\n","language":"javascript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"let srcList;\nconst getImageBtn = document.getElementById('get');\n\ngetImageBtn.addEventListener('click', async () => {\n  // 获取当前活动页\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    let message = { start: true };\n    // 向content scripts发送消息\n    chrome.tabs.sendMessage(tab.id, message, (res) => {\n      srcList = Array.from(new Set(res));\n      // popup中展示图片\n      const imgList = srcList.map((src) => `<img src=\"${src}\" />`).join('');\n\n      document.getElementById('app').innerHTML = imgList;\n    });\n  });\n});\n\nconst saveImageBtn = document.getElementById('save');\n\nsaveImageBtn.addEventListener('click', () => {\n  // 保存图片\n});\n"}]}]}]},{"type":"element","tag":"code","props":{"code":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n    <script src=\"./js/popup.js\"></script>\n  </body>\n</html>\n","language":"html"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"UTF-8\" />\n    <style>\n      body,\n      img {\n        width: 400px;\n      }\n    </style>\n  </head>\n  <body>\n    <button id=\"get\">获取</button>\n    <button id=\"save\">保存</button>\n    <div id=\"app\"></div>\n    <script src=\"./js/popup.js\"></script>\n  </body>\n</html>\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这里我们需要注意，插件要想和当前活动页面通信就需要首先获取它的 tabId，而要获取当前活动页面的 tabId 则需要给予插件对应的权限，因此我们需要在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"manifest.json"}]},{"type":"text","value":"中声明所需要的权限。"}]},{"type":"element","tag":"code","props":{"code":"{\n  ...\n  \"permissions\": [\n    \"activeTab\"\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  ...\n  \"permissions\": [\n    \"activeTab\"\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"完成后更新一下插件，然后打开想要获取图片的页面点击获取按钮即可（如果页面已经提前打开请刷新一下）"}]},{"type":"element","tag":"h5","props":{"id":"保存图片"},"children":[{"type":"text","value":"保存图片"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"js 可以通过 a 标签设置 href 和 download 属性来实现批量保存图片，但是这里我们要通过调用 chrome 的 download API 来实现。"}]},{"type":"element","tag":"code","props":{"code":"...\n\nsaveImageBtn.addEventListener('click', () => {\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    if (!srcList) {\n      document.getElementById('app').innerHTML = '未获取图片';\n      return;\n    }\n\n    srcList.forEach((src) => {\n      chrome.downloads.download({\n        url: src,\n      });\n    });\n  });\n});\n","language":"javascript"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"...\n\nsaveImageBtn.addEventListener('click', () => {\n  chrome.tabs.query({ active: true, currentWindow: true }, ([tab]) => {\n    if (!srcList) {\n      document.getElementById('app').innerHTML = '未获取图片';\n      return;\n    }\n\n    srcList.forEach((src) => {\n      chrome.downloads.download({\n        url: src,\n      });\n    });\n  });\n});\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"与获取活动页面相同，download API 同样也需要获取权限"}]},{"type":"element","tag":"code","props":{"code":"{\n  ...\n  \"permissions\": [\n    \"activeTab\",\n    \"downloads\"\n  ]\n}\n","language":"json"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"{\n  ...\n  \"permissions\": [\n    \"activeTab\",\n    \"downloads\"\n  ]\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这样一个获取当前页面图片的插件就完成了。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"完整项目："},{"type":"element","tag":"a","props":{"href":"https://github.com/qiyuor2/chrome-extension-getimage","rel":["nofollow"]},"children":[{"type":"text","value":"qiyuor2/chrome-extension-getimage"}]}]}]},{"type":"element","tag":"h2","props":{"id":"参考文章"},"children":[{"type":"text","value":"参考文章"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://developer.chrome.com/docs/extensions/mv3/getstarted/","rel":["nofollow"]},"children":[{"type":"text","value":"谷歌官方文档"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://juejin.cn/post/6844903740646899720","rel":["nofollow"]},"children":[{"type":"text","value":"一篇文章教你顺利入门和开发 chrome 扩展程序（插件）"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://juejin.cn/post/6844903985711677453","rel":["nofollow"]},"children":[{"type":"text","value":"入门系列 3 - background、content、popup 的通信"}]}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"什么是-chrome-插件","depth":2,"text":"什么是 Chrome 插件"},{"id":"获取页面上的图片","depth":2,"text":"获取页面上的图片","children":[{"id":"创建-manifest","depth":3,"text":"创建 manifest"}]},{"id":"参考文章","depth":2,"text":"参考文章"}]}},"_type":"markdown","_id":"content:2021:chrome-ext-get-image.md","_source":"content","_file":"2021/chrome-ext-get-image.md","_extension":"md"},"hash":"ADEk6ujvvt"}