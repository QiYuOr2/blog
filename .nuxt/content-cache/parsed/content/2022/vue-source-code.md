{"parsed":{"_path":"/2022/vue-source-code","_dir":"2022","_draft":false,"_partial":false,"_locale":"en","_empty":false,"title":"Vue.js 源码学习 - 初始化","description":"对于Vue.js 技术揭秘与 Vue 源码的学习笔记","excerpt":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"对于"},{"type":"element","tag":"a","props":{"href":"https://ustbhuangyi.github.io/vue-analysis/v2/prepare/","rel":["nofollow"]},"children":[{"type":"text","value":"Vue.js 技术揭秘"}]},{"type":"text","value":"与 Vue 源码的学习笔记"}]},{"type":"element","tag":"h2","props":{"id":"构建与入口"},"children":[{"type":"text","value":"构建与入口"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Vue.js 通过执行"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"node scripts/build.js"}]},{"type":"text","value":"进行构建"}]},{"type":"element","tag":"code","props":{"code":"if (process.argv[2]) {\n  const filters = process.argv[2].split(\",\");\n  builds = builds.filter((b) => {\n    return filters.some((f) => b.output.file.indexOf(f) > -1 || b._name.indexOf(f) > -1);\n  });\n} else {\n  builds = builds.filter((b) => {\n    return b.output.file.indexOf(\"weex\") === -1;\n  });\n}\n\nbuild(builds);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (process.argv[2]) {\n  const filters = process.argv[2].split(\",\");\n  builds = builds.filter((b) => {\n    return filters.some((f) => b.output.file.indexOf(f) > -1 || b._name.indexOf(f) > -1);\n  });\n} else {\n  builds = builds.filter((b) => {\n    return b.output.file.indexOf(\"weex\") === -1;\n  });\n}\n\nbuild(builds);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这段代码针对构建命令"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"npm run build -- web-runtime-cjs,web-server-renderer"}]},{"type":"text","value":"传入的参数不同进行过滤，向"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"build"}]},{"type":"text","value":"函数中传入了不同的参数，这些参数都配置在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"scripts/config.js"}]},{"type":"text","value":"中，声明了编译的入口、出口、格式、环境"}]},{"type":"element","tag":"code","props":{"code":"const builds = {\n  // Runtime only (CommonJS). Used by bundlers e.g. Webpack & Browserify\n  \"web-runtime-cjs-dev\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.dev.js\"),\n    format: \"cjs\",\n    env: \"development\",\n    banner,\n  },\n  \"web-runtime-cjs-prod\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.prod.js\"),\n    format: \"cjs\",\n    env: \"production\",\n    banner,\n  },\n  //...\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"const builds = {\n  // Runtime only (CommonJS). Used by bundlers e.g. Webpack & Browserify\n  \"web-runtime-cjs-dev\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.dev.js\"),\n    format: \"cjs\",\n    env: \"development\",\n    banner,\n  },\n  \"web-runtime-cjs-prod\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.prod.js\"),\n    format: \"cjs\",\n    env: \"production\",\n    banner,\n  },\n  //...\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Runtime Only"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"该版本的 Vue.js 需要借助 vue-loader 编译 .vue 文件"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Runtime + Compiler"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"该版本的 Vue.js 带有编译器，能够在客户端将 template 编译成 render 函数，大致效果可以理解为下面的两段代码"}]},{"type":"element","tag":"code","props":{"code":"new Vue({\n  template: \"<div>{{ hi }}</div>\",\n});\n\nnew Vue({\n  render(h) {\n    return h(\"div\", this.hi);\n  },\n});\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"new Vue({\n  template: \"<div>{{ hi }}</div>\",\n});\n\nnew Vue({\n  render(h) {\n    return h(\"div\", this.hi);\n  },\n});\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"入口文件"},"children":[{"type":"text","value":"入口文件"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之前提到"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config.js"}]},{"type":"text","value":"中声明了编译版本的入口文件，这样就很方便的找到了 Runtime + Compiler 版本的入口文件所在的位置"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/entry-runtime-with-compiler.js"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"可以看到该文件的最底部有一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"export default Vue"}]},{"type":"text","value":"，我们写 Vue 项目时的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"import Vue from 'vue"}]},{"type":"text","value":"就是从这里倒入的（这里是构建前的代码，实际上是从构建后的代码中倒入），不过一般情况下我们开发使用的是 Runtime Only"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/entry-runtime.js"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这个入口文件中 Vue 的来源是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"import Vue from './runtime/index'"}]},{"type":"text","value":"，而在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/runtime/index.js"}]},{"type":"text","value":"中可以看到，Vue 真正初始化的位置是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/index.js"}]}]},{"type":"element","tag":"code","props":{"code":"import Vue from \"./instance/index\";\nimport { initGlobalAPI } from \"./global-api/index\";\nimport { isServerRendering } from \"core/util/env\";\nimport { FunctionalRenderContext } from \"core/vdom/create-functional-component\";\n\ninitGlobalAPI(Vue);\n\n// ...\n\nexport default Vue;\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"import Vue from \"./instance/index\";\nimport { initGlobalAPI } from \"./global-api/index\";\nimport { isServerRendering } from \"core/util/env\";\nimport { FunctionalRenderContext } from \"core/vdom/create-functional-component\";\n\ninitGlobalAPI(Vue);\n\n// ...\n\nexport default Vue;\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在这里通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"initGlobalAPI(Vue)"}]},{"type":"text","value":"初始化了 Vue 的全局 API，我们见到的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Vue.set"}]},{"type":"text","value":"，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Vue.nextTick"}]},{"type":"text","value":"，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Vue.use"}]},{"type":"text","value":"等 API 都是在这里挂载到 Vue 上的"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"而 Vue 本身声明在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/index.js"}]},{"type":"text","value":"中"}]},{"type":"element","tag":"code","props":{"code":"import { initMixin } from \"./init\";\nimport { stateMixin } from \"./state\";\nimport { renderMixin } from \"./render\";\nimport { eventsMixin } from \"./events\";\nimport { lifecycleMixin } from \"./lifecycle\";\nimport { warn } from \"../util/index\";\n\nfunction Vue(options) {\n  if (process.env.NODE_ENV !== \"production\" && !(this instanceof Vue)) {\n    warn(\"Vue is a constructor and should be called with the `new` keyword\");\n  }\n  this._init(options);\n}\n\ninitMixin(Vue);\nstateMixin(Vue);\neventsMixin(Vue);\nlifecycleMixin(Vue);\nrenderMixin(Vue);\n\nexport default Vue;\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"import { initMixin } from \"./init\";\nimport { stateMixin } from \"./state\";\nimport { renderMixin } from \"./render\";\nimport { eventsMixin } from \"./events\";\nimport { lifecycleMixin } from \"./lifecycle\";\nimport { warn } from \"../util/index\";\n\nfunction Vue(options) {\n  if (process.env.NODE_ENV !== \"production\" && !(this instanceof Vue)) {\n    warn(\"Vue is a constructor and should be called with the `new` keyword\");\n  }\n  this._init(options);\n}\n\ninitMixin(Vue);\nstateMixin(Vue);\neventsMixin(Vue);\nlifecycleMixin(Vue);\nrenderMixin(Vue);\n\nexport default Vue;\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"new-vue"},"children":[{"type":"text","value":"new Vue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"当我们"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"new Vue({ ... })"}]},{"type":"text","value":"初始化时，调用了"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"this._init"}]},{"type":"text","value":"方法，该方法是通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"initMixin(Vue)"}]},{"type":"text","value":"挂载到 Vue 上的，定义在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/init.js"}]},{"type":"text","value":"中，而"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"_init"}]},{"type":"text","value":"方法主要逻辑就是进行一些初始化行为：生命周期、data、props 等内容的初始化"}]},{"type":"element","tag":"code","props":{"code":"Vue.prototype._init = function (options?: Object) {\n  const vm: Component = this;\n  // a uid\n  vm._uid = uid++;\n\n  let startTag, endTag;\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    startTag = `vue-perf-start:${vm._uid}`;\n    endTag = `vue-perf-end:${vm._uid}`;\n    mark(startTag);\n  }\n\n  // a flag to avoid this being observed\n  vm._isVue = true;\n  // merge options\n  if (options && options._isComponent) {\n    // optimize internal component instantiation\n    // since dynamic options merging is pretty slow, and none of the\n    // internal component options needs special treatment.\n    initInternalComponent(vm, options);\n  } else {\n    vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || {}, vm);\n  }\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== \"production\") {\n    initProxy(vm);\n  } else {\n    vm._renderProxy = vm;\n  }\n  // expose real self\n  vm._self = vm;\n  initLifecycle(vm);\n  initEvents(vm);\n  initRender(vm);\n  callHook(vm, \"beforeCreate\");\n  initInjections(vm); // resolve injections before data/props\n  initState(vm);\n  initProvide(vm); // resolve provide after data/props\n  callHook(vm, \"created\");\n\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    vm._name = formatComponentName(vm, false);\n    mark(endTag);\n    measure(`vue ${vm._name} init`, startTag, endTag);\n  }\n\n  if (vm.$options.el) {\n    vm.$mount(vm.$options.el);\n  }\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Vue.prototype._init = function (options?: Object) {\n  const vm: Component = this;\n  // a uid\n  vm._uid = uid++;\n\n  let startTag, endTag;\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    startTag = `vue-perf-start:${vm._uid}`;\n    endTag = `vue-perf-end:${vm._uid}`;\n    mark(startTag);\n  }\n\n  // a flag to avoid this being observed\n  vm._isVue = true;\n  // merge options\n  if (options && options._isComponent) {\n    // optimize internal component instantiation\n    // since dynamic options merging is pretty slow, and none of the\n    // internal component options needs special treatment.\n    initInternalComponent(vm, options);\n  } else {\n    vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || {}, vm);\n  }\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== \"production\") {\n    initProxy(vm);\n  } else {\n    vm._renderProxy = vm;\n  }\n  // expose real self\n  vm._self = vm;\n  initLifecycle(vm);\n  initEvents(vm);\n  initRender(vm);\n  callHook(vm, \"beforeCreate\");\n  initInjections(vm); // resolve injections before data/props\n  initState(vm);\n  initProvide(vm); // resolve provide after data/props\n  callHook(vm, \"created\");\n\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    vm._name = formatComponentName(vm, false);\n    mark(endTag);\n    measure(`vue ${vm._name} init`, startTag, endTag);\n  }\n\n  if (vm.$options.el) {\n    vm.$mount(vm.$options.el);\n  }\n};\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"vmmount"},"children":[{"type":"text","value":"vm.$mount"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 init 的最后会通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$mount"}]},{"type":"text","value":"挂载 Vue 实例，而"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"在不同平台、构建方式下都有所不同。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/runtime/index.js"}]},{"type":"text","value":"中定义了一个通用的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"，无论是在哪个平台、哪个构建方式下最终都会调用这个通用的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"，只不过会有一些不同的前置操作"}]},{"type":"element","tag":"code","props":{"code":"// public mount method\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  el = el && inBrowser ? query(el) : undefined;\n  return mountComponent(this, el, hydrating);\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// public mount method\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  el = el && inBrowser ? query(el) : undefined;\n  return mountComponent(this, el, hydrating);\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/entry-runtime-with-compiler.js"}]},{"type":"text","value":"中就是实现缓存了该"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"之后重写了它"}]},{"type":"element","tag":"code","props":{"code":"const mount = Vue.prototype.$mount;\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  //...\n\n  return mount.call(this, el, hydrating);\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"const mount = Vue.prototype.$mount;\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  //...\n\n  return mount.call(this, el, hydrating);\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在该模式下，由于需要编译 template，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"增加了一些前置操作"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先是禁止挂载到 html 或 body 上"}]},{"type":"element","tag":"code","props":{"code":"if (el === document.body || el === document.documentElement) {\n  process.env.NODE_ENV !== \"production\" && warn(`Do not mount Vue to <html> or <body> - mount to normal elements instead.`);\n  return this;\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (el === document.body || el === document.documentElement) {\n  process.env.NODE_ENV !== \"production\" && warn(`Do not mount Vue to <html> or <body> - mount to normal elements instead.`);\n  return this;\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然后通过判断传入的是 template 还是 render 方法，如果是 template 则需要转化为 render 方法，转化所调用的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"compileToFunctions"}]},{"type":"text","value":"引入自"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/compiler/index.js"}]},{"type":"text","value":"，compiler 目录下包含了 Vue.js 所有的编译相关的代码"}]},{"type":"element","tag":"code","props":{"code":"if (!options.render) {\n  let template = options.template;\n  if (template) {\n    if (typeof template === \"string\") {\n      if (template.charAt(0) === \"#\") {\n        template = idToTemplate(template);\n        /* istanbul ignore if */\n        if (process.env.NODE_ENV !== \"production\" && !template) {\n          warn(`Template element not found or is empty: ${options.template}`, this);\n        }\n      }\n    } else if (template.nodeType) {\n      template = template.innerHTML;\n    } else {\n      if (process.env.NODE_ENV !== \"production\") {\n        warn(\"invalid template option:\" + template, this);\n      }\n      return this;\n    }\n  } else if (el) {\n    template = getOuterHTML(el);\n  }\n  if (template) {\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile\");\n    }\n\n    const { render, staticRenderFns } = compileToFunctions(\n      template,\n      {\n        outputSourceRange: process.env.NODE_ENV !== \"production\",\n        shouldDecodeNewlines,\n        shouldDecodeNewlinesForHref,\n        delimiters: options.delimiters,\n        comments: options.comments,\n      },\n      this\n    );\n    options.render = render;\n    options.staticRenderFns = staticRenderFns;\n\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile end\");\n      measure(`vue ${this._name} compile`, \"compile\", \"compile end\");\n    }\n  }\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (!options.render) {\n  let template = options.template;\n  if (template) {\n    if (typeof template === \"string\") {\n      if (template.charAt(0) === \"#\") {\n        template = idToTemplate(template);\n        /* istanbul ignore if */\n        if (process.env.NODE_ENV !== \"production\" && !template) {\n          warn(`Template element not found or is empty: ${options.template}`, this);\n        }\n      }\n    } else if (template.nodeType) {\n      template = template.innerHTML;\n    } else {\n      if (process.env.NODE_ENV !== \"production\") {\n        warn(\"invalid template option:\" + template, this);\n      }\n      return this;\n    }\n  } else if (el) {\n    template = getOuterHTML(el);\n  }\n  if (template) {\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile\");\n    }\n\n    const { render, staticRenderFns } = compileToFunctions(\n      template,\n      {\n        outputSourceRange: process.env.NODE_ENV !== \"production\",\n        shouldDecodeNewlines,\n        shouldDecodeNewlinesForHref,\n        delimiters: options.delimiters,\n        comments: options.comments,\n      },\n      this\n    );\n    options.render = render;\n    options.staticRenderFns = staticRenderFns;\n\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile end\");\n      measure(`vue ${this._name} compile`, \"compile\", \"compile end\");\n    }\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最后就是调用缓存的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mount"}]},{"type":"text","value":"，在这个方法中调用了"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mountComponent"}]},{"type":"text","value":"，也就是说真正挂载 Vue 实例的函数是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/lifecycle.js"}]},{"type":"text","value":"中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mountComponent"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mountComponet"}]},{"type":"text","value":"的核心逻辑就是通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._render"}]},{"type":"text","value":"生成 VNode 以及通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._update"}]},{"type":"text","value":"更新 DOM，在初始化时会通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"new Watcher"}]},{"type":"text","value":"(Watcher 的构造函数)执行一遍"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._update"}]},{"type":"text","value":"和"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._render"}]}]},{"type":"element","tag":"h2","props":{"id":"render"},"children":[{"type":"text","value":"render"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._render"}]},{"type":"text","value":"声明在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/render.js"}]},{"type":"text","value":"中，该方法最关键的逻辑就是对于用户声明的 render 或是通过 template 编译出的 render 的调用"}]},{"type":"element","tag":"code","props":{"code":"vnode = render.call(vm._renderProxy, vm.$createElement);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"vnode = render.call(vm._renderProxy, vm.$createElement);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._renderProxy"}]},{"type":"text","value":"实际上就是 this，在初始化的逻辑中可以找到，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$createElement"}]},{"type":"text","value":"是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/vdom/create-element.js"}]},{"type":"text","value":"中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElement"}]},{"type":"text","value":"函数，用户手写的 render 时的入参就是该函数。"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElement"}]},{"type":"text","value":"最终会创建 VNode 并返回。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"new VNode"}]},{"type":"text","value":"之前会进行 children 的规范化操作，将 children 变为"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"VNode[]"}]}]},{"type":"element","tag":"code","props":{"code":"if (normalizationType === ALWAYS_NORMALIZE) {\n  children = normalizeChildren(children);\n} else if (normalizationType === SIMPLE_NORMALIZE) {\n  children = simpleNormalizeChildren(children);\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (normalizationType === ALWAYS_NORMALIZE) {\n  children = normalizeChildren(children);\n} else if (normalizationType === SIMPLE_NORMALIZE) {\n  children = simpleNormalizeChildren(children);\n}\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"update"},"children":[{"type":"text","value":"update"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._update"}]},{"type":"text","value":"会将"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.render"}]},{"type":"text","value":"返回的 vnode 传入"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"中，渲染为真实 DOM，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"在 web 和 weex 上实现方法是不同的，因此分别定义在了"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms"}]},{"type":"text","value":"的 web 和 weex 中"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/vdom/patch.js"}]},{"type":"text","value":"中"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createPatchFunction"}]},{"type":"text","value":"创建出来的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"patch"}]},{"type":"text","value":"函数。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createPatchFunction"}]},{"type":"text","value":"的入参是一些定义好的 DOM 操作函数和一些钩子函数，采用这样的做法而不是在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/vdom/patch.js"}]},{"type":"text","value":"中直接 import 的原因是 web 和 weex 的这些 DOM 操作和钩子不同，但是创建"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"使用的是同一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createPatchFunction"}]}]},{"type":"element","tag":"h3","props":{"id":"初始化的-patch"},"children":[{"type":"text","value":"初始化的 patch"}]},{"type":"element","tag":"code","props":{"code":"new Vue({\n  el: \"#app\",\n  render: function (createElement) {\n    return createElement(\n      \"div\",\n      {\n        attrs: {\n          id: \"app\",\n        },\n      },\n      this.message\n    );\n  },\n  data: {\n    message: \"Hello Vue!\",\n  },\n});\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"new Vue({\n  el: \"#app\",\n  render: function (createElement) {\n    return createElement(\n      \"div\",\n      {\n        attrs: {\n          id: \"app\",\n        },\n      },\n      this.message\n    );\n  },\n  data: {\n    message: \"Hello Vue!\",\n  },\n});\n"}]}]}]},{"type":"element","tag":"code","props":{"code":"vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"入参中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$el"}]},{"type":"text","value":"是在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"时获取到的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<div id=\"app\">"}]},{"type":"text","value":"，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hydrating"}]},{"type":"text","value":"在非服务端渲染时都是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"false"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"patch"}]},{"type":"text","value":"会将"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$el"}]},{"type":"text","value":"转为 VNode，之后通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElm"}]},{"type":"text","value":"将 VNode 创建为真实 DOM 并插入父节点"}]},{"type":"element","tag":"code","props":{"code":"if (isRealElement) {\n  // mounting to a real element\n  // check if this is server-rendered content and if we can perform\n  // a successful hydration.\n  if (oldVnode.nodeType === 1 && oldVnode.hasAttribute(SSR_ATTR)) {\n    oldVnode.removeAttribute(SSR_ATTR);\n    hydrating = true;\n  }\n  if (isTrue(hydrating)) {\n    // ...\n  }\n  // either not server-rendered, or hydration failed.\n  // create an empty node and replace it\n  oldVnode = emptyNodeAt(oldVnode);\n}\n\n// replacing existing element\nconst oldElm = oldVnode.elm;\nconst parentElm = nodeOps.parentNode(oldElm);\n\n// create new node\ncreateElm(\n  vnode,\n  insertedVnodeQueue,\n  // extremely rare edge case: do not insert if old element is in a\n  // leaving transition. Only happens when combining transition +\n  // keep-alive + HOCs. (#4590)\n  oldElm._leaveCb ? null : parentElm,\n  nodeOps.nextSibling(oldElm)\n);\n// ...\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (isRealElement) {\n  // mounting to a real element\n  // check if this is server-rendered content and if we can perform\n  // a successful hydration.\n  if (oldVnode.nodeType === 1 && oldVnode.hasAttribute(SSR_ATTR)) {\n    oldVnode.removeAttribute(SSR_ATTR);\n    hydrating = true;\n  }\n  if (isTrue(hydrating)) {\n    // ...\n  }\n  // either not server-rendered, or hydration failed.\n  // create an empty node and replace it\n  oldVnode = emptyNodeAt(oldVnode);\n}\n\n// replacing existing element\nconst oldElm = oldVnode.elm;\nconst parentElm = nodeOps.parentNode(oldElm);\n\n// create new node\ncreateElm(\n  vnode,\n  insertedVnodeQueue,\n  // extremely rare edge case: do not insert if old element is in a\n  // leaving transition. Only happens when combining transition +\n  // keep-alive + HOCs. (#4590)\n  oldElm._leaveCb ? null : parentElm,\n  nodeOps.nextSibling(oldElm)\n);\n// ...\n"}]}]}]},{"type":"element","tag":"code","props":{"code":"// function createElm\n\nvnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n\n// ...\n\nif (isDef(tag)) {\n  if (process.env.NODE_ENV !== \"production\") {\n    if (data && data.pre) {\n      creatingElmInVPre++;\n    }\n    if (isUnknownElement(vnode, creatingElmInVPre)) {\n      warn(\n        \"Unknown custom element: <\" +\n          tag +\n          \"> - did you \" +\n          \"register the component correctly? For recursive components, \" +\n          'make sure to provide the \"name\" option.',\n        vnode.context\n      );\n    }\n  }\n\n  vnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n  setScope(vnode);\n\n  /* istanbul ignore if */\n  if (__WEEX__) {\n    // ...\n  } else {\n    createChildren(vnode, children, insertedVnodeQueue);\n    if (isDef(data)) {\n      invokeCreateHooks(vnode, insertedVnodeQueue);\n    }\n    insert(parentElm, vnode.elm, refElm);\n  }\n\n  if (process.env.NODE_ENV !== \"production\" && data && data.pre) {\n    creatingElmInVPre--;\n  }\n} else if (isTrue(vnode.isComment)) {\n  // 注释\n  vnode.elm = nodeOps.createComment(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n} else {\n  // 文本\n  vnode.elm = nodeOps.createTextNode(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// function createElm\n\nvnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n\n// ...\n\nif (isDef(tag)) {\n  if (process.env.NODE_ENV !== \"production\") {\n    if (data && data.pre) {\n      creatingElmInVPre++;\n    }\n    if (isUnknownElement(vnode, creatingElmInVPre)) {\n      warn(\n        \"Unknown custom element: <\" +\n          tag +\n          \"> - did you \" +\n          \"register the component correctly? For recursive components, \" +\n          'make sure to provide the \"name\" option.',\n        vnode.context\n      );\n    }\n  }\n\n  vnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n  setScope(vnode);\n\n  /* istanbul ignore if */\n  if (__WEEX__) {\n    // ...\n  } else {\n    createChildren(vnode, children, insertedVnodeQueue);\n    if (isDef(data)) {\n      invokeCreateHooks(vnode, insertedVnodeQueue);\n    }\n    insert(parentElm, vnode.elm, refElm);\n  }\n\n  if (process.env.NODE_ENV !== \"production\" && data && data.pre) {\n    creatingElmInVPre--;\n  }\n} else if (isTrue(vnode.isComment)) {\n  // 注释\n  vnode.elm = nodeOps.createComment(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n} else {\n  // 文本\n  vnode.elm = nodeOps.createTextNode(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"其中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createChildren"}]},{"type":"text","value":"是对于"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElm"}]},{"type":"text","value":"的递归调用，遍历所有的子节点，它的入参"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"insertedVnodeQueue"}]},{"type":"text","value":"是通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"invokeCreateHooks"}]},{"type":"text","value":"创建的，它会将 vnode 放到"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"insertedVnodeQueue"}]},{"type":"text","value":"中。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最终"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"patch"}]},{"type":"text","value":"就会将完整的 DOM 树创建出来"}]}]},"date":"2022/07/07 14:44:39","summary":"对于Vue.js 技术揭秘与Vue源码的学习笔记","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"对于"},{"type":"element","tag":"a","props":{"href":"https://ustbhuangyi.github.io/vue-analysis/v2/prepare/","rel":["nofollow"]},"children":[{"type":"text","value":"Vue.js 技术揭秘"}]},{"type":"text","value":"与 Vue 源码的学习笔记"}]},{"type":"element","tag":"h2","props":{"id":"构建与入口"},"children":[{"type":"text","value":"构建与入口"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Vue.js 通过执行"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"node scripts/build.js"}]},{"type":"text","value":"进行构建"}]},{"type":"element","tag":"code","props":{"code":"if (process.argv[2]) {\n  const filters = process.argv[2].split(\",\");\n  builds = builds.filter((b) => {\n    return filters.some((f) => b.output.file.indexOf(f) > -1 || b._name.indexOf(f) > -1);\n  });\n} else {\n  builds = builds.filter((b) => {\n    return b.output.file.indexOf(\"weex\") === -1;\n  });\n}\n\nbuild(builds);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (process.argv[2]) {\n  const filters = process.argv[2].split(\",\");\n  builds = builds.filter((b) => {\n    return filters.some((f) => b.output.file.indexOf(f) > -1 || b._name.indexOf(f) > -1);\n  });\n} else {\n  builds = builds.filter((b) => {\n    return b.output.file.indexOf(\"weex\") === -1;\n  });\n}\n\nbuild(builds);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这段代码针对构建命令"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"npm run build -- web-runtime-cjs,web-server-renderer"}]},{"type":"text","value":"传入的参数不同进行过滤，向"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"build"}]},{"type":"text","value":"函数中传入了不同的参数，这些参数都配置在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"scripts/config.js"}]},{"type":"text","value":"中，声明了编译的入口、出口、格式、环境"}]},{"type":"element","tag":"code","props":{"code":"const builds = {\n  // Runtime only (CommonJS). Used by bundlers e.g. Webpack & Browserify\n  \"web-runtime-cjs-dev\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.dev.js\"),\n    format: \"cjs\",\n    env: \"development\",\n    banner,\n  },\n  \"web-runtime-cjs-prod\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.prod.js\"),\n    format: \"cjs\",\n    env: \"production\",\n    banner,\n  },\n  //...\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"const builds = {\n  // Runtime only (CommonJS). Used by bundlers e.g. Webpack & Browserify\n  \"web-runtime-cjs-dev\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.dev.js\"),\n    format: \"cjs\",\n    env: \"development\",\n    banner,\n  },\n  \"web-runtime-cjs-prod\": {\n    entry: resolve(\"web/entry-runtime.js\"),\n    dest: resolve(\"dist/vue.runtime.common.prod.js\"),\n    format: \"cjs\",\n    env: \"production\",\n    banner,\n  },\n  //...\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Runtime Only"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"该版本的 Vue.js 需要借助 vue-loader 编译 .vue 文件"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Runtime + Compiler"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"该版本的 Vue.js 带有编译器，能够在客户端将 template 编译成 render 函数，大致效果可以理解为下面的两段代码"}]},{"type":"element","tag":"code","props":{"code":"new Vue({\n  template: \"<div>{{ hi }}</div>\",\n});\n\nnew Vue({\n  render(h) {\n    return h(\"div\", this.hi);\n  },\n});\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"new Vue({\n  template: \"<div>{{ hi }}</div>\",\n});\n\nnew Vue({\n  render(h) {\n    return h(\"div\", this.hi);\n  },\n});\n"}]}]}]},{"type":"element","tag":"h3","props":{"id":"入口文件"},"children":[{"type":"text","value":"入口文件"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"之前提到"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"config.js"}]},{"type":"text","value":"中声明了编译版本的入口文件，这样就很方便的找到了 Runtime + Compiler 版本的入口文件所在的位置"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/entry-runtime-with-compiler.js"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"可以看到该文件的最底部有一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"export default Vue"}]},{"type":"text","value":"，我们写 Vue 项目时的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"import Vue from 'vue"}]},{"type":"text","value":"就是从这里倒入的（这里是构建前的代码，实际上是从构建后的代码中倒入），不过一般情况下我们开发使用的是 Runtime Only"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/entry-runtime.js"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这个入口文件中 Vue 的来源是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"import Vue from './runtime/index'"}]},{"type":"text","value":"，而在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/runtime/index.js"}]},{"type":"text","value":"中可以看到，Vue 真正初始化的位置是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/index.js"}]}]},{"type":"element","tag":"code","props":{"code":"import Vue from \"./instance/index\";\nimport { initGlobalAPI } from \"./global-api/index\";\nimport { isServerRendering } from \"core/util/env\";\nimport { FunctionalRenderContext } from \"core/vdom/create-functional-component\";\n\ninitGlobalAPI(Vue);\n\n// ...\n\nexport default Vue;\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"import Vue from \"./instance/index\";\nimport { initGlobalAPI } from \"./global-api/index\";\nimport { isServerRendering } from \"core/util/env\";\nimport { FunctionalRenderContext } from \"core/vdom/create-functional-component\";\n\ninitGlobalAPI(Vue);\n\n// ...\n\nexport default Vue;\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在这里通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"initGlobalAPI(Vue)"}]},{"type":"text","value":"初始化了 Vue 的全局 API，我们见到的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Vue.set"}]},{"type":"text","value":"，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Vue.nextTick"}]},{"type":"text","value":"，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Vue.use"}]},{"type":"text","value":"等 API 都是在这里挂载到 Vue 上的"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"而 Vue 本身声明在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/index.js"}]},{"type":"text","value":"中"}]},{"type":"element","tag":"code","props":{"code":"import { initMixin } from \"./init\";\nimport { stateMixin } from \"./state\";\nimport { renderMixin } from \"./render\";\nimport { eventsMixin } from \"./events\";\nimport { lifecycleMixin } from \"./lifecycle\";\nimport { warn } from \"../util/index\";\n\nfunction Vue(options) {\n  if (process.env.NODE_ENV !== \"production\" && !(this instanceof Vue)) {\n    warn(\"Vue is a constructor and should be called with the `new` keyword\");\n  }\n  this._init(options);\n}\n\ninitMixin(Vue);\nstateMixin(Vue);\neventsMixin(Vue);\nlifecycleMixin(Vue);\nrenderMixin(Vue);\n\nexport default Vue;\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"import { initMixin } from \"./init\";\nimport { stateMixin } from \"./state\";\nimport { renderMixin } from \"./render\";\nimport { eventsMixin } from \"./events\";\nimport { lifecycleMixin } from \"./lifecycle\";\nimport { warn } from \"../util/index\";\n\nfunction Vue(options) {\n  if (process.env.NODE_ENV !== \"production\" && !(this instanceof Vue)) {\n    warn(\"Vue is a constructor and should be called with the `new` keyword\");\n  }\n  this._init(options);\n}\n\ninitMixin(Vue);\nstateMixin(Vue);\neventsMixin(Vue);\nlifecycleMixin(Vue);\nrenderMixin(Vue);\n\nexport default Vue;\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"new-vue"},"children":[{"type":"text","value":"new Vue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"当我们"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"new Vue({ ... })"}]},{"type":"text","value":"初始化时，调用了"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"this._init"}]},{"type":"text","value":"方法，该方法是通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"initMixin(Vue)"}]},{"type":"text","value":"挂载到 Vue 上的，定义在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/init.js"}]},{"type":"text","value":"中，而"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"_init"}]},{"type":"text","value":"方法主要逻辑就是进行一些初始化行为：生命周期、data、props 等内容的初始化"}]},{"type":"element","tag":"code","props":{"code":"Vue.prototype._init = function (options?: Object) {\n  const vm: Component = this;\n  // a uid\n  vm._uid = uid++;\n\n  let startTag, endTag;\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    startTag = `vue-perf-start:${vm._uid}`;\n    endTag = `vue-perf-end:${vm._uid}`;\n    mark(startTag);\n  }\n\n  // a flag to avoid this being observed\n  vm._isVue = true;\n  // merge options\n  if (options && options._isComponent) {\n    // optimize internal component instantiation\n    // since dynamic options merging is pretty slow, and none of the\n    // internal component options needs special treatment.\n    initInternalComponent(vm, options);\n  } else {\n    vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || {}, vm);\n  }\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== \"production\") {\n    initProxy(vm);\n  } else {\n    vm._renderProxy = vm;\n  }\n  // expose real self\n  vm._self = vm;\n  initLifecycle(vm);\n  initEvents(vm);\n  initRender(vm);\n  callHook(vm, \"beforeCreate\");\n  initInjections(vm); // resolve injections before data/props\n  initState(vm);\n  initProvide(vm); // resolve provide after data/props\n  callHook(vm, \"created\");\n\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    vm._name = formatComponentName(vm, false);\n    mark(endTag);\n    measure(`vue ${vm._name} init`, startTag, endTag);\n  }\n\n  if (vm.$options.el) {\n    vm.$mount(vm.$options.el);\n  }\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"Vue.prototype._init = function (options?: Object) {\n  const vm: Component = this;\n  // a uid\n  vm._uid = uid++;\n\n  let startTag, endTag;\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    startTag = `vue-perf-start:${vm._uid}`;\n    endTag = `vue-perf-end:${vm._uid}`;\n    mark(startTag);\n  }\n\n  // a flag to avoid this being observed\n  vm._isVue = true;\n  // merge options\n  if (options && options._isComponent) {\n    // optimize internal component instantiation\n    // since dynamic options merging is pretty slow, and none of the\n    // internal component options needs special treatment.\n    initInternalComponent(vm, options);\n  } else {\n    vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || {}, vm);\n  }\n  /* istanbul ignore else */\n  if (process.env.NODE_ENV !== \"production\") {\n    initProxy(vm);\n  } else {\n    vm._renderProxy = vm;\n  }\n  // expose real self\n  vm._self = vm;\n  initLifecycle(vm);\n  initEvents(vm);\n  initRender(vm);\n  callHook(vm, \"beforeCreate\");\n  initInjections(vm); // resolve injections before data/props\n  initState(vm);\n  initProvide(vm); // resolve provide after data/props\n  callHook(vm, \"created\");\n\n  /* istanbul ignore if */\n  if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n    vm._name = formatComponentName(vm, false);\n    mark(endTag);\n    measure(`vue ${vm._name} init`, startTag, endTag);\n  }\n\n  if (vm.$options.el) {\n    vm.$mount(vm.$options.el);\n  }\n};\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"vmmount"},"children":[{"type":"text","value":"vm.$mount"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 init 的最后会通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$mount"}]},{"type":"text","value":"挂载 Vue 实例，而"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"在不同平台、构建方式下都有所不同。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/runtime/index.js"}]},{"type":"text","value":"中定义了一个通用的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"，无论是在哪个平台、哪个构建方式下最终都会调用这个通用的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"，只不过会有一些不同的前置操作"}]},{"type":"element","tag":"code","props":{"code":"// public mount method\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  el = el && inBrowser ? query(el) : undefined;\n  return mountComponent(this, el, hydrating);\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// public mount method\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  el = el && inBrowser ? query(el) : undefined;\n  return mountComponent(this, el, hydrating);\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms/web/entry-runtime-with-compiler.js"}]},{"type":"text","value":"中就是实现缓存了该"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"之后重写了它"}]},{"type":"element","tag":"code","props":{"code":"const mount = Vue.prototype.$mount;\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  //...\n\n  return mount.call(this, el, hydrating);\n};\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"const mount = Vue.prototype.$mount;\nVue.prototype.$mount = function (el?: string | Element, hydrating?: boolean): Component {\n  //...\n\n  return mount.call(this, el, hydrating);\n};\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在该模式下，由于需要编译 template，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"增加了一些前置操作"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先是禁止挂载到 html 或 body 上"}]},{"type":"element","tag":"code","props":{"code":"if (el === document.body || el === document.documentElement) {\n  process.env.NODE_ENV !== \"production\" && warn(`Do not mount Vue to <html> or <body> - mount to normal elements instead.`);\n  return this;\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (el === document.body || el === document.documentElement) {\n  process.env.NODE_ENV !== \"production\" && warn(`Do not mount Vue to <html> or <body> - mount to normal elements instead.`);\n  return this;\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然后通过判断传入的是 template 还是 render 方法，如果是 template 则需要转化为 render 方法，转化所调用的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"compileToFunctions"}]},{"type":"text","value":"引入自"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/compiler/index.js"}]},{"type":"text","value":"，compiler 目录下包含了 Vue.js 所有的编译相关的代码"}]},{"type":"element","tag":"code","props":{"code":"if (!options.render) {\n  let template = options.template;\n  if (template) {\n    if (typeof template === \"string\") {\n      if (template.charAt(0) === \"#\") {\n        template = idToTemplate(template);\n        /* istanbul ignore if */\n        if (process.env.NODE_ENV !== \"production\" && !template) {\n          warn(`Template element not found or is empty: ${options.template}`, this);\n        }\n      }\n    } else if (template.nodeType) {\n      template = template.innerHTML;\n    } else {\n      if (process.env.NODE_ENV !== \"production\") {\n        warn(\"invalid template option:\" + template, this);\n      }\n      return this;\n    }\n  } else if (el) {\n    template = getOuterHTML(el);\n  }\n  if (template) {\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile\");\n    }\n\n    const { render, staticRenderFns } = compileToFunctions(\n      template,\n      {\n        outputSourceRange: process.env.NODE_ENV !== \"production\",\n        shouldDecodeNewlines,\n        shouldDecodeNewlinesForHref,\n        delimiters: options.delimiters,\n        comments: options.comments,\n      },\n      this\n    );\n    options.render = render;\n    options.staticRenderFns = staticRenderFns;\n\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile end\");\n      measure(`vue ${this._name} compile`, \"compile\", \"compile end\");\n    }\n  }\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (!options.render) {\n  let template = options.template;\n  if (template) {\n    if (typeof template === \"string\") {\n      if (template.charAt(0) === \"#\") {\n        template = idToTemplate(template);\n        /* istanbul ignore if */\n        if (process.env.NODE_ENV !== \"production\" && !template) {\n          warn(`Template element not found or is empty: ${options.template}`, this);\n        }\n      }\n    } else if (template.nodeType) {\n      template = template.innerHTML;\n    } else {\n      if (process.env.NODE_ENV !== \"production\") {\n        warn(\"invalid template option:\" + template, this);\n      }\n      return this;\n    }\n  } else if (el) {\n    template = getOuterHTML(el);\n  }\n  if (template) {\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile\");\n    }\n\n    const { render, staticRenderFns } = compileToFunctions(\n      template,\n      {\n        outputSourceRange: process.env.NODE_ENV !== \"production\",\n        shouldDecodeNewlines,\n        shouldDecodeNewlinesForHref,\n        delimiters: options.delimiters,\n        comments: options.comments,\n      },\n      this\n    );\n    options.render = render;\n    options.staticRenderFns = staticRenderFns;\n\n    /* istanbul ignore if */\n    if (process.env.NODE_ENV !== \"production\" && config.performance && mark) {\n      mark(\"compile end\");\n      measure(`vue ${this._name} compile`, \"compile\", \"compile end\");\n    }\n  }\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最后就是调用缓存的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mount"}]},{"type":"text","value":"，在这个方法中调用了"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mountComponent"}]},{"type":"text","value":"，也就是说真正挂载 Vue 实例的函数是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/lifecycle.js"}]},{"type":"text","value":"中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mountComponent"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"mountComponet"}]},{"type":"text","value":"的核心逻辑就是通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._render"}]},{"type":"text","value":"生成 VNode 以及通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._update"}]},{"type":"text","value":"更新 DOM，在初始化时会通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"new Watcher"}]},{"type":"text","value":"(Watcher 的构造函数)执行一遍"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._update"}]},{"type":"text","value":"和"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._render"}]}]},{"type":"element","tag":"h2","props":{"id":"render"},"children":[{"type":"text","value":"render"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._render"}]},{"type":"text","value":"声明在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/instance/render.js"}]},{"type":"text","value":"中，该方法最关键的逻辑就是对于用户声明的 render 或是通过 template 编译出的 render 的调用"}]},{"type":"element","tag":"code","props":{"code":"vnode = render.call(vm._renderProxy, vm.$createElement);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"vnode = render.call(vm._renderProxy, vm.$createElement);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._renderProxy"}]},{"type":"text","value":"实际上就是 this，在初始化的逻辑中可以找到，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$createElement"}]},{"type":"text","value":"是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/vdom/create-element.js"}]},{"type":"text","value":"中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElement"}]},{"type":"text","value":"函数，用户手写的 render 时的入参就是该函数。"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElement"}]},{"type":"text","value":"最终会创建 VNode 并返回。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"new VNode"}]},{"type":"text","value":"之前会进行 children 的规范化操作，将 children 变为"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"VNode[]"}]}]},{"type":"element","tag":"code","props":{"code":"if (normalizationType === ALWAYS_NORMALIZE) {\n  children = normalizeChildren(children);\n} else if (normalizationType === SIMPLE_NORMALIZE) {\n  children = simpleNormalizeChildren(children);\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (normalizationType === ALWAYS_NORMALIZE) {\n  children = normalizeChildren(children);\n} else if (normalizationType === SIMPLE_NORMALIZE) {\n  children = simpleNormalizeChildren(children);\n}\n"}]}]}]},{"type":"element","tag":"h2","props":{"id":"update"},"children":[{"type":"text","value":"update"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm._update"}]},{"type":"text","value":"会将"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.render"}]},{"type":"text","value":"返回的 vnode 传入"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"中，渲染为真实 DOM，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"在 web 和 weex 上实现方法是不同的，因此分别定义在了"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/platforms"}]},{"type":"text","value":"的 web 和 weex 中"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/vdom/patch.js"}]},{"type":"text","value":"中"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createPatchFunction"}]},{"type":"text","value":"创建出来的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"patch"}]},{"type":"text","value":"函数。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createPatchFunction"}]},{"type":"text","value":"的入参是一些定义好的 DOM 操作函数和一些钩子函数，采用这样的做法而不是在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"src/core/vdom/patch.js"}]},{"type":"text","value":"中直接 import 的原因是 web 和 weex 的这些 DOM 操作和钩子不同，但是创建"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.__patch__"}]},{"type":"text","value":"使用的是同一个"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createPatchFunction"}]}]},{"type":"element","tag":"h3","props":{"id":"初始化的-patch"},"children":[{"type":"text","value":"初始化的 patch"}]},{"type":"element","tag":"code","props":{"code":"new Vue({\n  el: \"#app\",\n  render: function (createElement) {\n    return createElement(\n      \"div\",\n      {\n        attrs: {\n          id: \"app\",\n        },\n      },\n      this.message\n    );\n  },\n  data: {\n    message: \"Hello Vue!\",\n  },\n});\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"new Vue({\n  el: \"#app\",\n  render: function (createElement) {\n    return createElement(\n      \"div\",\n      {\n        attrs: {\n          id: \"app\",\n        },\n      },\n      this.message\n    );\n  },\n  data: {\n    message: \"Hello Vue!\",\n  },\n});\n"}]}]}]},{"type":"element","tag":"code","props":{"code":"vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */);\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */);\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"入参中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$el"}]},{"type":"text","value":"是在"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$mount"}]},{"type":"text","value":"时获取到的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"<div id=\"app\">"}]},{"type":"text","value":"，"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"hydrating"}]},{"type":"text","value":"在非服务端渲染时都是"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"false"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"patch"}]},{"type":"text","value":"会将"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"vm.$el"}]},{"type":"text","value":"转为 VNode，之后通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElm"}]},{"type":"text","value":"将 VNode 创建为真实 DOM 并插入父节点"}]},{"type":"element","tag":"code","props":{"code":"if (isRealElement) {\n  // mounting to a real element\n  // check if this is server-rendered content and if we can perform\n  // a successful hydration.\n  if (oldVnode.nodeType === 1 && oldVnode.hasAttribute(SSR_ATTR)) {\n    oldVnode.removeAttribute(SSR_ATTR);\n    hydrating = true;\n  }\n  if (isTrue(hydrating)) {\n    // ...\n  }\n  // either not server-rendered, or hydration failed.\n  // create an empty node and replace it\n  oldVnode = emptyNodeAt(oldVnode);\n}\n\n// replacing existing element\nconst oldElm = oldVnode.elm;\nconst parentElm = nodeOps.parentNode(oldElm);\n\n// create new node\ncreateElm(\n  vnode,\n  insertedVnodeQueue,\n  // extremely rare edge case: do not insert if old element is in a\n  // leaving transition. Only happens when combining transition +\n  // keep-alive + HOCs. (#4590)\n  oldElm._leaveCb ? null : parentElm,\n  nodeOps.nextSibling(oldElm)\n);\n// ...\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"if (isRealElement) {\n  // mounting to a real element\n  // check if this is server-rendered content and if we can perform\n  // a successful hydration.\n  if (oldVnode.nodeType === 1 && oldVnode.hasAttribute(SSR_ATTR)) {\n    oldVnode.removeAttribute(SSR_ATTR);\n    hydrating = true;\n  }\n  if (isTrue(hydrating)) {\n    // ...\n  }\n  // either not server-rendered, or hydration failed.\n  // create an empty node and replace it\n  oldVnode = emptyNodeAt(oldVnode);\n}\n\n// replacing existing element\nconst oldElm = oldVnode.elm;\nconst parentElm = nodeOps.parentNode(oldElm);\n\n// create new node\ncreateElm(\n  vnode,\n  insertedVnodeQueue,\n  // extremely rare edge case: do not insert if old element is in a\n  // leaving transition. Only happens when combining transition +\n  // keep-alive + HOCs. (#4590)\n  oldElm._leaveCb ? null : parentElm,\n  nodeOps.nextSibling(oldElm)\n);\n// ...\n"}]}]}]},{"type":"element","tag":"code","props":{"code":"// function createElm\n\nvnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n\n// ...\n\nif (isDef(tag)) {\n  if (process.env.NODE_ENV !== \"production\") {\n    if (data && data.pre) {\n      creatingElmInVPre++;\n    }\n    if (isUnknownElement(vnode, creatingElmInVPre)) {\n      warn(\n        \"Unknown custom element: <\" +\n          tag +\n          \"> - did you \" +\n          \"register the component correctly? For recursive components, \" +\n          'make sure to provide the \"name\" option.',\n        vnode.context\n      );\n    }\n  }\n\n  vnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n  setScope(vnode);\n\n  /* istanbul ignore if */\n  if (__WEEX__) {\n    // ...\n  } else {\n    createChildren(vnode, children, insertedVnodeQueue);\n    if (isDef(data)) {\n      invokeCreateHooks(vnode, insertedVnodeQueue);\n    }\n    insert(parentElm, vnode.elm, refElm);\n  }\n\n  if (process.env.NODE_ENV !== \"production\" && data && data.pre) {\n    creatingElmInVPre--;\n  }\n} else if (isTrue(vnode.isComment)) {\n  // 注释\n  vnode.elm = nodeOps.createComment(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n} else {\n  // 文本\n  vnode.elm = nodeOps.createTextNode(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n}\n","language":"js"},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"// function createElm\n\nvnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n\n// ...\n\nif (isDef(tag)) {\n  if (process.env.NODE_ENV !== \"production\") {\n    if (data && data.pre) {\n      creatingElmInVPre++;\n    }\n    if (isUnknownElement(vnode, creatingElmInVPre)) {\n      warn(\n        \"Unknown custom element: <\" +\n          tag +\n          \"> - did you \" +\n          \"register the component correctly? For recursive components, \" +\n          'make sure to provide the \"name\" option.',\n        vnode.context\n      );\n    }\n  }\n\n  vnode.elm = vnode.ns ? nodeOps.createElementNS(vnode.ns, tag) : nodeOps.createElement(tag, vnode);\n  setScope(vnode);\n\n  /* istanbul ignore if */\n  if (__WEEX__) {\n    // ...\n  } else {\n    createChildren(vnode, children, insertedVnodeQueue);\n    if (isDef(data)) {\n      invokeCreateHooks(vnode, insertedVnodeQueue);\n    }\n    insert(parentElm, vnode.elm, refElm);\n  }\n\n  if (process.env.NODE_ENV !== \"production\" && data && data.pre) {\n    creatingElmInVPre--;\n  }\n} else if (isTrue(vnode.isComment)) {\n  // 注释\n  vnode.elm = nodeOps.createComment(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n} else {\n  // 文本\n  vnode.elm = nodeOps.createTextNode(vnode.text);\n  insert(parentElm, vnode.elm, refElm);\n}\n"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"其中的"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createChildren"}]},{"type":"text","value":"是对于"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"createElm"}]},{"type":"text","value":"的递归调用，遍历所有的子节点，它的入参"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"insertedVnodeQueue"}]},{"type":"text","value":"是通过"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"invokeCreateHooks"}]},{"type":"text","value":"创建的，它会将 vnode 放到"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"insertedVnodeQueue"}]},{"type":"text","value":"中。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最终"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"patch"}]},{"type":"text","value":"就会将完整的 DOM 树创建出来"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"构建与入口","depth":2,"text":"构建与入口","children":[{"id":"入口文件","depth":3,"text":"入口文件"}]},{"id":"new-vue","depth":2,"text":"new Vue"},{"id":"vmmount","depth":2,"text":"vm.$mount"},{"id":"render","depth":2,"text":"render"},{"id":"update","depth":2,"text":"update","children":[{"id":"初始化的-patch","depth":3,"text":"初始化的 patch"}]}]}},"_type":"markdown","_id":"content:2022:vue-source-code.md","_source":"content","_file":"2022/vue-source-code.md","_extension":"md"},"hash":"7Qbmj9YzUt"}